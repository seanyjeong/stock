# Daily Stock Story v1.1 - 인증/권한 시스템 설계

**작성일:** 2026-01-24

---

## 사용자 플로우

```
┌─────────────────────────────────────────────────┐
│ 카카오 로그인                                     │
└─────────────────┬───────────────────────────────┘
                  ▼
         ┌───────────────┐
         │ 첫 가입자?     │
         └───────┬───────┘
           Yes   │   No
      ┌──────────┴──────────┐
      ▼                     ▼
┌─────────────┐     ┌─────────────────┐
│ 프리패스    │     │ 승인 대기 화면   │
│ (admin)     │     │ "관리자 승인 중" │
└─────┬───────┘     └────────┬────────┘
      │                      │ (승인 후)
      │              ┌───────▼────────┐
      │              │ 온보딩          │
      │              │ 1. 포트폴리오   │
      │              │ 2. 알림 설정    │
      │              │ 3. 스킵 가능    │
      │              └───────┬────────┘
      │                      │
      └──────────┬───────────┘
                 ▼
         ┌───────────────┐
         │ 대시보드       │
         └───────────────┘
```

---

## 권한 구조

| 역할 | 권한 |
|------|------|
| **admin** | 모든 기능 + /admin 페이지 + 사용자 승인 |
| **user** | 본인 포트폴리오 CRUD + 대시보드 |
| **pending** | 승인 대기 화면만 |

---

## DB 스키마

```sql
-- 사용자
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  kakao_id BIGINT UNIQUE NOT NULL,
  nickname VARCHAR(100),
  profile_image TEXT,
  role VARCHAR(20) DEFAULT 'pending',  -- admin, user, pending
  onboarding_done BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW(),
  approved_at TIMESTAMP
);

-- 포트폴리오 (사용자별)
CREATE TABLE portfolio (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  ticker VARCHAR(10) NOT NULL,
  shares INTEGER NOT NULL,
  avg_cost DECIMAL(10,4) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, ticker)
);

-- 알림 설정
CREATE TABLE notification_settings (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) UNIQUE,
  push_enabled BOOLEAN DEFAULT FALSE,
  briefing_times JSONB DEFAULT '["09:00", "18:00", "21:00"]',
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## API 엔드포인트

```
# 인증
POST /api/auth/kakao     # 카카오 로그인
GET  /api/auth/me        # 현재 사용자 정보
POST /api/auth/logout    # 로그아웃

# 관리자
GET  /api/admin/users           # 사용자 목록 (pending 포함)
POST /api/admin/users/{id}/approve  # 승인
DELETE /api/admin/users/{id}    # 거부/삭제

# 온보딩
POST /api/onboarding/complete   # 온보딩 완료
POST /api/onboarding/skip       # 스킵

# 포트폴리오 CRUD
GET    /api/portfolio           # 내 포트폴리오
POST   /api/portfolio           # 종목 추가
PUT    /api/portfolio/{ticker}  # 수정
DELETE /api/portfolio/{ticker}  # 삭제

# 알림 설정
GET  /api/notifications/settings
PUT  /api/notifications/settings
```

---

## 페이지 구조

```
/                    # 대시보드 (로그인 필요)
/login               # 카카오 로그인
/pending             # 승인 대기 화면
/onboarding          # 온보딩 (1. 포트폴리오 2. 알림 3. 완료)
/admin/users         # 관리자: 사용자 승인 (admin만)
/settings            # 설정 (알림, 계정)
```

---

## 초기 데이터 마이그레이션

Sean 첫 로그인 시:
```
1. users 테이블에 admin으로 자동 등록
2. portfolio.md 데이터 → portfolio 테이블 복사
   - BNAI: 464주, $9.55
   - GLSI: 67주, $25.22
3. onboarding_done = TRUE (스킵)
```

---

## 구현 순서

1. **DB 테이블 생성** - users, portfolio, notification_settings
2. **카카오 로그인 API** - mprojects 참고
3. **인증 미들웨어** - JWT 토큰
4. **승인 시스템** - admin 페이지
5. **온보딩 UI** - 3단계 위자드
6. **포트폴리오 CRUD** - API + UI

---

*설계 완료: 2026-01-24*
