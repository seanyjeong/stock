# 스캐너 시스템 로직 분석 (2026-01-26)

> `scanners/full_market_scanner.py` 전체 분석
> 문제점 + 개선안 포함

---

## 전체 구조

```
news_collector.py → daily_news_scores 테이블
                         ↓
full_market_scanner.py (3가지 모드)
  ├── --type day   → 단타 (뉴스 기반 소형주)
  ├── --type swing → 스윙 (고정 중형주 풀)
  └── --type long  → 장기 (고정 대형주 풀)
                         ↓
daily_scan_results 테이블 (JSONB) → /api/recommendations
```

---

## 현재 크론 스케줄

| 크론 (UTC) | KST 변환 | 동작 |
|------------|----------|------|
| `0 17 * * 1-5` | **02:00 KST** | 뉴스 수집 |
| `30 17 * * 1-5` | **02:30 KST** | 단타 스캔 |
| `0 9 * * 2-6` | **18:00 KST** | 스윙 스캔 |
| `5 9 * * 2-6` | **18:05 KST** | 장기 스캔 |

### 문제점

1. **단타가 새벽 2:30 KST에 실행** → 프리마켓은 18:00 KST (4:00 AM ET)
   - 프리마켓 1시간 전이 아니라 **16시간 전**에 실행됨
   - 의도: 17:30 KST = 3:30 AM ET (프리마켓 30분 전)
   - 실제: 17:30 UTC = 02:30 KST (새벽)

2. **스윙/장기가 18:00 KST에 실행** → 미국 장 마감 4:00 AM ET
   - 의도: 장 마감 후 분석
   - 실제: 09:00 UTC = 18:00 KST = 4:00 AM ET (장 마감 직후) ← 이건 맞음

3. **단타 결과가 덮어써짐** (치명적 버그!)
   - `save_scan_results()`가 3개 카테고리 전부를 한 행에 저장
   - `--type day` 실행 → `{day_trade: [5개], swing: [], longterm: []}`
   - `--type swing` 실행 → `{day_trade: [], swing: [5개], longterm: []}` ← **단타 날아감**
   - `--type long` 실행 → `{day_trade: [], swing: [], longterm: [5개]}` ← **스윙도 날아감**

---

## 추천 크론 스케줄

```
미국 시간대 기준:
- 프리마켓: 4:00 AM - 9:30 AM ET
- 정규장: 9:30 AM - 4:00 PM ET
- 애프터마켓: 4:00 PM - 8:00 PM ET
```

| 크론 (UTC) | KST | ET | 동작 | 이유 |
|------------|-----|-----|------|------|
| `0 8 * * 1-5` | 17:00 | 3:00 AM | 뉴스 수집 | 프리마켓 1시간 전 |
| `30 8 * * 1-5` | **17:30** | **3:30 AM** | **단타 스캔** | 프리마켓 직전 |
| `0 21 * * 1-5` | **06:00** | **4:00 PM** | **스윙 스캔** | 정규장 마감 직후 |
| `5 21 * * 1-5` | **06:05** | **4:05 PM** | **장기 스캔** | 정규장 마감 직후 |

> 핵심: UTC 시간 기준으로 크론 설정해야 함!
> - 단타: 프리마켓 직전 (최신 뉴스 반영)
> - 스윙/장기: 정규장 마감 직후 (당일 종가 반영)

---

## 1. 단타 (Day Trade) 로직

### 종목 풀
- **동적**: `daily_news_scores` 테이블에서 당일 뉴스 점수 상위 30개
- news_collector.py가 SEC EDGAR, Finviz, Yahoo Finance에서 수집
- 뉴스가 없으면 → 단타 추천 0개 (의존성 문제)

### 필터
| 조건 | 값 | 비고 |
|------|-----|------|
| 가격 | $1 ~ $100 | 페니스탁 제외, 고가주 제외 |
| 시가총액 | $50M ~ $5B | 소형주 집중 |
| 최소 점수 | 40점 | 미달 시 제외 |
| 데이터 | 최소 10일 히스토리 | |

### 점수 체계 (만점: 120+점 ← 문제!)

#### 기본 점수 (최대 120점)

| 항목 | 최대 | 기준 | 문제 |
|------|------|------|------|
| 거래량 급증 | 35 | >5x=35, >3x=30, >2x=25, >1.5x=15 | OK |
| RSI 반등 | 30 | 30-45=30, 25-30=25, 45-60=20, <25=10 | OK |
| MACD 크로스 | 30 | 골든=30, 양수>시그널=20, 시그널위=10 | OK |
| ATR 변동성 | 15 | 3-8%=15, 2-3%=10, >8%=5 | OK |
| 뉴스 | 10 | >10점=10, >5점=7, >0점=5 | 비중 낮음 |

#### 숏스퀴즈 보너스 (추가 +60점까지!)

| 항목 | 최대 | 기준 |
|------|------|------|
| SI >20% | +15 | shortPercentOfFloat |
| SI >10% | +10 | |
| SI 급증 | +10 | 30일 변화 >50% |
| FTD >10만 | +10 | SEC FTD 데이터 |
| RegSHO | +20 | NASDAQ Threshold |
| Zero Borrow | +15 | shortablestocks.com |
| Borrow Rate >50% | +10 | |

### 문제점

1. **점수 스케일이 0-100이 아님** → 기본 120 + 보너스 60 = **최대 180점**
2. **숏스퀴즈 보너스가 너무 큼** → 일반 종목은 max 120, 스퀴즈 종목은 180
3. **가격이 전날 종가** → `hist['Close'].iloc[-1]`은 정규장 종가
4. **뉴스 의존** → news_collector 실패 시 단타 추천 0개
5. **deep_analyzer 호출** → get_short_history, get_ftd_data 등 느림 (종목당 5-10초)

### 추천 전략
| 항목 | 현재 | 값 |
|------|------|-----|
| 매수가 | 현재가 -2% | `current_price * 0.98` |
| 손절가 | 현재가 - ATR*1.5 | |
| 목표가 | 현재가 +8% | `current_price * 1.08` |

---

## 2. 스윙 (Swing) 로직

### 종목 풀
- **고정 58개**: 성장 중형주
- 카테고리: 클라우드(PLTR, SNOW...), 바이오(MRNA, REGN...), 핀테크(PYPL, COIN...), EV(TSLA, RIVN...), 반도체(AMD, MU...), 기타(UBER, ABNB...)
- **문제: 고정 풀이라 새 종목 발견 불가**

### 필터
| 조건 | 값 | 비고 |
|------|-----|------|
| 가격 | > $5 | 저가주 제외 |
| 최소 점수 | 40점 | |
| 데이터 | 최소 30일 히스토리 (3개월 조회) | |

### 점수 체계 (만점: 150+점 ← 문제!)

#### 기본 점수 (최대 90점)

| 항목 | 최대 | 기준 |
|------|------|------|
| RSI 과매도 반등 | 30 | 25-40=30, 40-55=20, <25=15 |
| MACD 크로스 | 30 | 골든=30, 시그널위=15 |
| MA20 돌파 | 20 | 돌파직후=20, 지지테스트=15 |
| 50일선 위 | 10 | 상승 추세 확인 |

#### 촉매 보너스 (추가 +50점!)

| 항목 | 최대 | 기준 |
|------|------|------|
| 섹터 뉴스 >=3건 | +15 | get_sector_news |
| FDA 지정 (바이오) | +20 | fast_track, breakthrough |
| 임상 시험 | +10 | clinical_trials |
| EV 세액공제 | +10 | 자동차 섹터 |
| 배당 뉴스 (금융) | +10 | 금융 섹터 |
| Max Pain 아래 | +15 | 옵션 데이터 |
| Max Pain 위 | -5 | 하락 압력 |

### 문제점

1. **점수 스케일 안 맞음** → 기본 90 + 촉매 50 = **최대 140점**
2. **고정 종목 풀** → PLTR, SNOW 등 계속 같은 종목만 분석
3. **촉매가 특정 섹터만** → 바이오/자동차/금융만 촉매 체크, 나머지는 기본 뉴스만
4. **가격도 전날 종가**

### 추천 전략
| 항목 | 현재 | 값 |
|------|------|-----|
| 매수가 | 현재가 -5% | `current_price * 0.95` |
| 손절가 | 지지선 -5% | `support * 0.95` |
| 목표가 | 저항선 -5% | `resistance * 0.95` |

---

## 3. 장기 (Long-Term) 로직

### 종목 풀
- **고정 58개**: S&P 500 대형주 + 배당 귀족주
- 카테고리: 메가캡(AAPL, MSFT...), 배당(JNJ, KO...), 금융(JPM, GS...), 산업(XOM, CAT...), 통신(T, VZ...), 헬스케어(UNH, CVS...), 기술(ORCL, IBM...), 소비재(COST, NKE...)

### 필터
| 조건 | 값 | 비고 |
|------|-----|------|
| 시가총액 | > $10B | 대형주만 |
| 최소 점수 | 35점 | |
| 데이터 | 최소 100일 히스토리 (1년 조회) | |

### 점수 체계 (만점: 110점 - 가장 잘 설계됨)

#### 기본 점수 (최대 100점)

| 항목 | 최대 | 기준 | 설명 |
|------|------|------|------|
| 배당 수익률 | 25 | yield*500 (cap 25) | 5% → 25점 |
| P/E 비율 | 20 | 10-20=20, 구간별 감소 | 적정 밸류에이션 |
| 52주 위치 | 20 | 0.2-0.5=20 (저점 근처) | 저점 매수 기회 |
| 1년 수익률 | 15 | return*0.5 (cap 15) | 30% → 15점 |
| 변동성 | 10 | 10-volatility*3 | 낮을수록 좋음 |
| 배당 건전성 | 10 | 배당+배당성향 적정 | 지속 가능성 |

#### 추가 점수 (최대 +10점)

| 항목 | 최대 | 기준 |
|------|------|------|
| 기관 보유 60%+ | +10 | 신뢰도 지표 |
| 기관 보유 40%+ | +5 | |
| 저평가 (동종비교) | +10 | PE 섹터 평균 대비 |
| 고평가 | -5 | |

### 문제점 (가장 적음)

1. 이론상 최대 120점이지만 100점 넘기 어려운 구조 → 비교적 정상
2. 고정 종목 풀이지만 대형주라 괜찮음
3. **가격은 전날 종가** (장기라 큰 문제 아님)

### 추천 전략
| 항목 | 현재 | 값 |
|------|------|-----|
| 1차 매수 | 현재가 -10% | 분할매수 30% |
| 2차 매수 | 현재가 -15% | 분할매수 추가 |
| 손절가 | 52주 저가 -10% | |
| 목표가 | 52주 고가 -10% | |

---

## 4. 저장 로직 (버그)

```python
# save_scan_results() - 현재 코드
all_results = {
    'day_trade': sorted(day_results, ...)[:5],
    'swing': sorted(swing_results, ...)[:5],
    'longterm': sorted(long_results, ...)[:5],
}
# → --type day 실행 시 swing=[], longterm=[] 으로 덮어쓰기!
```

### 수정 필요

```python
# 수정안: 기존 데이터 읽고 해당 카테고리만 업데이트
existing = SELECT results FROM daily_scan_results WHERE scan_date = today
if existing:
    merged = {**existing, **new_results}  # 새 카테고리만 덮어쓰기
```

---

## 5. AI 분석 (Gemini)

- 모델: `gemini-2.0-flash`
- 용도: 각 추천 종목에 2문장 추천 이유 생성
- 호출: 종목당 1회 → 15개 추천 시 15회 API 호출
- 비용: gemini-2.0-flash는 저렴하지만 속도 영향

---

## 6. 등급 시스템

| 등급 | 점수 | 표시 |
|------|------|------|
| ★★★ | >= 70 | 강력 추천 |
| ★★ | >= 50 | 추천 |
| ★ | < 50 | 관심 |

### 문제: 단타/스윙은 100점 넘을 수 있어서 등급이 의미없음

---

## 종합 문제 요약

| # | 문제 | 심각도 | 카테고리 |
|---|------|--------|----------|
| 1 | **저장 시 카테고리 덮어쓰기** | 치명적 | 단타/스윙/장기 |
| 2 | **크론 시간 UTC/KST 혼동** | 높음 | 단타 |
| 3 | **점수 스케일 불일치** (단타 180, 스윙 140, 장기 110) | 높음 | 전체 |
| 4 | **가격이 전날 종가** | 중간 | 단타 (장기는 OK) |
| 5 | **고정 종목 풀** | 낮음 | 스윙/장기 (의도적) |
| 6 | **뉴스 의존성** (단타) | 중간 | 단타 |
| 7 | **deep_analyzer 호출 느림** | 낮음 | 단타 |
| 8 | **숏스퀴즈 보너스 과다** | 중간 | 단타 |

---

## 수정 우선순위

### 즉시 수정 (P0)
1. `save_scan_results()` → 카테고리별 MERGE
2. 크론 시간 수정 (UTC 기준으로 올바르게)

### 이번 주 (P1)
3. 점수 0-100 정규화 (전 카테고리)
4. 단타 가격 → `stock.info.get('currentPrice')` 사용

### 나중에 (P2)
5. 스윙 종목 풀 동적화
6. 뉴스 실패 시 폴백 로직
7. AI 호출 최적화 (배치)
